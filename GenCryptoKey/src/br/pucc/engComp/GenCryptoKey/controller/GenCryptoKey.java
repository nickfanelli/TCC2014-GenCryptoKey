package br.pucc.engComp.GenCryptoKey.controller;

import java.util.ArrayList;
import java.util.Calendar;

import br.pucc.engComp.GenCryptoKey.evaluation.EvaluationTests;
import br.pucc.engComp.GenCryptoKey.models.GenerationDAO;
import br.pucc.engComp.GenCryptoKey.models.KeypairDAO;
import br.pucc.engComp.GenCryptoKey.models.SettingsDAO;
import br.pucc.engComp.GenCryptoKey.views.Home;

public final class GenCryptoKey {

	public static RSAKeypair rsaKeypair;
	public static KeypairPOJO generatedKeypair;
	public static Population myPop = null;
	public static boolean usingPreviousGenerationFromDatabase = false;
	public static boolean autoEvaluatingKeys = false;

	// Suppressing the constructor as this class is supposed to be used only statically
	private GenCryptoKey(){}

	// Set Settings attributes with the appropriate values and check with user which population should be used as input
	// This routine must be done before the processing begins in background
	public static void initParameters() {
		long initParametersStartTime = System.currentTimeMillis();
		DB.getConnection();

		// Check database for previously saved settings
		// If there are saved settings on DB, populate them
		ArrayList<SettingsPOJO> previousSettings = null;
		try {
			previousSettings = SettingsDAO.getAllSettingsProfiles();
		} catch (Exception e) {
			e.printStackTrace();
		}

		if(previousSettings != null && !previousSettings.isEmpty()) { // Use the last saved settings --> (previousSettings.size()-1)
			System.out.println("[LOG - INFO] -- Fetching user-defined settings saved on a previous run.");
			Settings.setIndividualSize(previousSettings.get(previousSettings.size()-1).getIndividualSize());
			Settings.setInitialPopulationSize(previousSettings.get(previousSettings.size()-1).getInitialPopulationSize());
			Settings.setNumOfCrossoverPoints(previousSettings.get(previousSettings.size()-1).getNumOfCrossoverPoints());
			Settings.setNumOfMutationsPerIndividual(previousSettings.get(previousSettings.size()-1).getNumOfMutationsPerIndividual());
			Settings.setMutationRate(previousSettings.get(previousSettings.size()-1).getMutationRate());
			Settings.setPercentageOfIndividualsToCross(previousSettings.get(previousSettings.size()-1).getPercentageOfIndividualsToCross());
			Settings.setMaxPopulationSize(previousSettings.get(previousSettings.size()-1).getMaxPopulationSize());
			Settings.setMaxGenerationsToStop(previousSettings.get(previousSettings.size()-1).getMaxGenerationsToStop());
			Settings.setScheduledKeyGeneration(previousSettings.get(previousSettings.size()-1).isScheduledKeyGeneration());
			Settings.setScheduledKeyGenerationTime(previousSettings.get(previousSettings.size()-1).getScheduledKeyGenerationTime());
			Settings.setWriteLogActive(previousSettings.get(previousSettings.size()-1).isWriteLogActive());
		}

		System.out.println("[LOG - DEBUG] -- individualSize = " + Settings.getIndividualSize());
		System.out.println("[LOG - DEBUG] -- initialPopulationSize = " + Settings.getInitialPopulationSize());
		System.out.println("[LOG - DEBUG] -- numOfCrossoverPoints = " + Settings.getNumOfCrossoverPoints());
		System.out.println("[LOG - DEBUG] -- numOfMutationsPerIndividual = " + Settings.getNumOfMutationsPerIndividual());
		System.out.println("[LOG - DEBUG] -- mutationRate = " + Settings.getMutationRate());
		System.out.println("[LOG - DEBUG] -- percentageOfIndividualsToCross = " + Settings.getPercentageOfIndividualsToCross());
		System.out.println("[LOG - DEBUG] -- maxPopulationSize = " + Settings.getMaxPopulationSize());
		System.out.println("[LOG - DEBUG] -- maxGenerationsToStop = " + Settings.getMaxGenerationsToStop());
		//      System.out.println("[LOG - DEBUG] -- scheduledKeyGeneration = " + Settings.isScheduledKeyGeneration());
		//      System.out.println("[LOG - DEBUG] -- scheduledKeyGenerationTime = " + Settings.getScheduledKeyGenerationTime());
		//		System.out.println("[LOG - DEBUG] -- writeLog = " + Settings.isWriteLogActive());



		// This If-else block: obtain initial population
		if(autoEvaluatingKeys) { // Run this segment only when executing the program for evaluation generated keys
			// All that is needed in this case is an initial population
			myPop = new Population(null);
		} else {
			// If a generation of same key size is saved on database, use that instead of creating a new one
			try {
				if(GenerationDAO.isRegistered(Settings.getIndividualSize())) {
					if(Home.queryUserForLastGenerationAsInput()) {
						usingPreviousGenerationFromDatabase = true;
						myPop = new Population(GenerationDAO.getGenerationByKeySize(Settings.getIndividualSize()));
					} else {
						myPop = new Population(null);
					}
				} else {
					myPop = new Population(null);
				}
			} catch (Exception e) {
				e.printStackTrace();
				System.out.println("[LOG - ERROR] -- Error checking for registered generation in database: " + e.getMessage());
			}
		}

		System.out.println("[LOG - DEBUG] -- initParameteres() duration: " + (System.currentTimeMillis() - initParametersStartTime) + "ms");
	}

	public static void run() {
		// Evolve the algorithm to find optimal, fit solution

		System.out.println("Cheguei aqui 2");
		// Evaluation and ranking of the population are only necessary when they're new
		// thus haven't passed through this process before
		if(usingPreviousGenerationFromDatabase) {
			System.out.println("Cheguei aqui 2");
			GeneticAlgorithm.evaluateFitness(myPop);
			System.out.println("Cheguei aqui 3");
			GeneticAlgorithm.rankSelection(myPop);
			System.out.println("Cheguei aqui 4");
		}

		int generationCount = 0;
		long initGATime = System.currentTimeMillis();
		do {
			System.out.println("Cheguei aqui 5 - entrei no loop");
			generationCount++;
			System.out.println("######################################## GENERATION #: " + generationCount + " #####################################################");
			System.out.println("######################################## GENERATION #: " + generationCount + " #####################################################");
			GeneticAlgorithm.evolvePopulation(myPop);
		} while (generationCount < Settings.getMaxGenerationsToStop()); // For testing and debugging reasons, this limit can be hard coded.
		// Otherwise, use -> Settings.getMaxGenerationsToStop()
		long endGATime = System.currentTimeMillis();
		System.out.println("[LOG - DEBUG] -- Evolved population up to: " + generationCount + " generations.");
		System.out.println("[LOG - DEBUG] -- Run() duration: " + ((endGATime - initGATime)/1000.00) + "s");

		if(!autoEvaluatingKeys) { // Run this segment only when NOT executing the program for evaluation generated keys
			// Save last generation to database
			try {
				ArrayList<Individual> generation = myPop.getPopulation();
				if(GenerationDAO.newGeneration(generation) != -1) {
					// Generation successfully saved to database
					System.out.println("[LOG - INFO] -- Generation saved.");
				}
			} catch (Exception e) {
				e.printStackTrace();
				System.out.println("[LOG - ERROR] -- Error saving generation to database: " + e.getMessage());
			}

			// Generate key pair using the fitest individual as base
			rsaKeypair = new RSAKeypair(myPop.getIndividual(0));
			rsaKeypair.generateKeyPair();

			generatedKeypair = new KeypairPOJO();
			generatedKeypair.setGeneratedKeyBase64(RSAKeypair.toBase64(rsaKeypair));// FIXME: convert to PEM specification
			generatedKeypair.setPublicExponent(rsaKeypair.getE().toString());
			generatedKeypair.setPrivateExponent(rsaKeypair.getD().toString());
			generatedKeypair.setModulus(rsaKeypair.getN().toString());
			// Keypair description is set from user input off of the message dialog
			generatedKeypair.setKeypairDescription(Home.queryUserForKeypairDescription());
			generatedKeypair.setGenerationTimestamp(Calendar.getInstance());

			try {
				if(KeypairDAO.newKeypair(generatedKeypair) != -1) {
					//JOptionPane.showMessageDialog(null, "New keypair registered.", "Keypair registered", JOptionPane.INFORMATION_MESSAGE);
					System.out.println("[LOG - INFO] -- New keypair registered.");
				}
			} catch (Exception e) {
				e.printStackTrace();
				System.out.println("Error inserting keypair to database: " + e.getMessage());
			}

			rsaKeypair.printExample();
		}
		System.out.println("[LOG - INFO] -- Execution complete.");
	}

	public static void runGraphically() {
		// TODO Run graphical execution where user can follow the whole key generation process
	}

	public static void runEvaluationTests(int numOfIndividualsToEvaluate) {
		long evaluationTestsStartTime = System.currentTimeMillis();
		String individualForEvaluation = null;
		int lengthOfindividualForEvaluation = 0;

		// Switching ON auto evaluation flag on to skip code segments with user and database interaction
		autoEvaluatingKeys = true;
		usingPreviousGenerationFromDatabase = false;

		for(int i = 0; i < numOfIndividualsToEvaluate; i++) {
			initParameters();
			run();

			// Retrieve the fittest individual
			individualForEvaluation = myPop.getIndividual(0).toBinaryString();
			lengthOfindividualForEvaluation = individualForEvaluation.length();

			// Validating individual length
			if(lengthOfindividualForEvaluation < Settings.getIndividualSize()) { // (e.g. 1023 < 1024) when this happens ...
				int numOfMissingDigits = Settings.getIndividualSize() - lengthOfindividualForEvaluation; //  ... it will most likely be missing only 1 digit
				lengthOfindividualForEvaluation += numOfMissingDigits; // so the length of the individual is corrected ...
				System.out.println("[LOG - DEBUG] -- numOfMissingDigits: " + numOfMissingDigits + " | lengthOfindividualForEvaluation: " + lengthOfindividualForEvaluation);
				do {
					individualForEvaluation = individualForEvaluation.concat("1"); // ... by appending a '1' to the end of the binary string ...
					numOfMissingDigits--;
				} while(numOfMissingDigits > 0); // ... however many times necessary to adjust to the correct size
			}

			// Export individual to file
			// The evaluation file grows as more individuals are appended to it
			ExportKey.exportBinaryIndividualForEvaluation(individualForEvaluation);
		}
		// Perform evaluation tests
		EvaluationTests.Evaluate(1024, numOfIndividualsToEvaluate); // ([stream length], [number of streams in the evaluation file])

		//		String ind1 = "1011011101010110000000010011001001100000110111000011110100100111010111110110101111010001010101000011010110010110111010111000110000011000111101011000001100101001110001100011010011010100010010001001100011110010101101010110100111100101010101100000001010110000110100010011001001110011010011010011110000011100101111011001000000000000100000000100101111111010100100010010000001101111110101100011110111010110101010010110010011110001101000000110111100001000110010100001100001110100000011010101110110011000010100011100001100110001100101100011000001100010000111011111111001110100100111001100000111110000000100111101111111001110100100010001000000100000000010011111100001011001001001000000000000101000001011000010000010101111110000110010010001100110011000100001101011000100101110011011110101000111100100001011111011100000111011001110001110010010100001001010100101000111111100101010110001100101010110001111011111010000000111101101000011011101101101100110101000101010101101110101010100011010001001101000010101111000010111110100100000000111";
		//		String ind2 = "1010111110010001000001101101010110000101001011100000010111100001011001100011111000101001001001000000101101100111111010000110001110001011001100001011001100111101010010010000110101001011100011000000100001001101001100001110111011001101100011011110010110011010001100111100001011110101011010110010100010010111101010100010001010001011111010011001011111011010001011011110111011011111011111010000001110110110011000010111000011101110101011111010100110110011111101101001111101010110001010000110100101001011110100000100100101010000000001111111111001101111111101010110010000011011000000101110011010110111011111101011011100110000111111001000001011101010000111000110111000100111111001001010011101010100000001101011111100100011100100001001110101000000100100010000000001001101101111101011001101000001111001101001110100011001000011011100110100101100011111100010101001011111101111000110101000001101101001101011111001101101111011001011100100011110110110010001101100010010000110101110111110101001011110100101110101011110111001101001100000011110";
		//		String ind3 = "1101100001001100111000000101001101011101110111100000110101010100101011101001001110000101011110001000100000001001011010010000110101000011010000001000111010101110001100110101010100000101011000001111001111011011010111001110011110111001010011110110001000101001100100100111101000000011000001111111001000011110100001100101101100100100000010110011011001001110111001110101110100001000001010110100111111101011001010111011111111100101101000011010001100110101111111011010110101100011101000000111110011011011011001100100100001111110010100110101111011001001000011010101100010110011111111001000011010100111000100000100101111110001001011000100001111001011001010011110011011010110101001010100110001100001000100110011011110000111111001000101011000101110010111110000110110010000011101010110010100000011100111100100001111110101011000001101010101100000101001001100111011101000111101110011011101011010100011111101100111110100100010111111010111010011000111100001100011100110101010111000111100110110111110110010110010010111010100001000111110000011";
		//		String ind4 = "1001010101001011110100011010010001000101110111011010010110000110110101110010111110011111001000010001001111100001100101000001000100101010010110010011000011101000000111111100010011111111101010011001010010000111011000101010111010000100100001111100011111010000001101000100000010100010101011100001101111101110000100101000010010001001111101010000110001100100000111111110010011011000101000001001111011110010001101111111111001101000100110110001111001100010101001010101110001100001000110101000111110011101010101011001110100000000101011000000010010001111000110001101101001111111101010011111111000101000001111000100111111010100001111011100101000000010111010001011001010010010101010111111100111101111110000110000001011011111111010110110100101011000110111001001100001010000011110111101000010100111001110001010011100010100100111101001100010110110011110110100010100011011011000001001100010111101111011111101100011111111101011010101010011001111101101000110000011101001100001011010111000100101011100001010010011000100000000110100100001100110";
		//		String ind5 = "1000111010001110111111001010000101110101101001111110010010001110100010100111000011111111111000101000100001010110111110101100000111101010010001010111001010001111110011110101011001101101110110010100111000100011011000111011111110010110110101111111100101011100111011000111000100011010100010010001010001001111100010000110000010110111101101111101011010100100110011111111011100001011010110100011001000001101011011001101011001100110010111001111110011010110100001011110001000110011110011111000011001000110011111100010001001101001001100111000011101000100011101100011101011000110010010111100001111110100100010101000111101011101010010000001011100100011001101000110011010100000101010100111011101111000111011010011111000100000101100001010100011011010110100111111011110000101110110000010011011110101010010101011001111100110011001010111110100101111001110010110000010001010010100011010010101111010001000100001010111110110011010111010011101100110110111011110011101000101110001010000101101111101001100010001011111101111010000101110100111100111";
		//		String ind6 = "1011101100111111111000010101100110100010110100110101001001011010010011011010111101000110111110001100100110100100110011110101101111011011100100111010100111100000100010010011101111100011010001001010000101101100011011110101100100111011100011111011111010100110110101010101010100001010101011011001011010011101100000100101011110111000110001011001101111001110101010011000011001111011000011001000100110111110010100001011001011100110000011000011011010010000101110011101001110110001110001100111111111111110011101110101011111100001100011000100100100101010000011010101001001101010001001000111110000011110010000110110100101100111111100001011101101110100100000100001010101101100100111010000010101000111101110100111011011110100100110000111101000111110001101000000000100000000110000110111111001000101011010101101111011001101100001000000001110000000110010101000101001101011011110000111010000111011000110010001100110101011010111111011110011111111110101110111000100100010000110000011101101010000111010010101110101010001001001111100101001001111";
		//		String ind7 = "1010011110001101011011011000100101000011101010111101011111110100101010101110110010101011001000110110100111000100010001101110111100100110000110011111011001011110011000001110100111101011111100011100111011111100110100011100011100001101101100110001010010100100110010101110000010101111011110001010111101000001001110001001111001110000111001001010101010101101010100010101011000000100100001001001110001000001101010011111011010110011101010011001000000011010001100011001011100111101100110010000110100011110100110100001111010000010101101101111100111101110001011010111101111001010001001100011100110111011000011111110000111100011110100100011010110001000011111111011010000111101000101101000010100000101010111110001101111100100110000011110110101100011101110010011000110110111111000101001110010111010111110100000100111010110001110100011010100111100010010110111100111101100000000001010110110000001001111001010010101011101010101001010100100100010111010110001011000101000010111001100011101100010100010001111011101000011101011100101001011001001";
		//		String ind8 = "1010101110010111001011101001011111010111011011111011111000101101101100110100100111010011110100101111010010001110011011000111110101010000101101010100001001011011001110110100000110000011001000110111001101010000001011111011010110001000000001100101001111111000101010111110001100000100100000110101101011110000001101111000001010011010111011011011100101000110010000111001101000011111000010001001101010001001010110000101100101101110111101001000011110100110010101101011010001111101110010000011010000111110110010100111101110010001010101010111100011011101000110001000101000101010011111010011011100100101011000011001001001111111101010000101000110100000101010110000100100011011001110001010100101011111001011111111001111100110001111111011111111000010100010000010011000011011101101010000001100000000000111011100000101110010000100000111111010000000100000110100100110001101100111101101101110100110011111010011111111110101000111110100000101111000100101101011100011001110111111001011011011000010101111100000100001011010000100010110100111001011";
		//		String ind9 = "1101000100000000010010111000010111111110100011001010111100100111011001110011111011111010000101001000011011110111011100111101111000000001110000101111011011011000101111000001100111101110101001101110100011101000001000001100010101110101001001011110011100001110000100000010001100000011111100101101011100011101111010010010111101100110001000010000001010011101011111111000001111011011100100000111110011110101011001010011001001101110101010010111110110101101000000001001110000011001110001001011101110010011110000101000110011111110101011100010000011011010111101010011111110000011000111101000000111100010010111001110010100001000110011101100101100011101000011000101110000100010001001101100000011001000111101110100010010110010010101111000110100101100001100110101101110100010110110011000101111110110100110010111000010010001100011110000001110111111100101001111010011100010101001001000000101110100011100110001000011111101000010010101100110111100011001000111111010100110011110100110101101111011100010011100100000101001010111110101111110001101";
		//		String ind10 = "1010010101011000100010000001111010110001001111110101000111111101010111011000100101011001000100101101011001100010100010000001100001010010011000100011110010100111000011010110011111010100110010000011010000000010001011001101111010011100011101111111011111010000100010000010100010110011101110000011001101000110011110000001101000111010100100100110011000001110011011010010111000010000111110001111100101011010100100100000101111111011000011011101011100110110101100010011111001101100010001110101111001101100110010010100101101111010111110101001011100000101110110111001111110111000010100110011011101011111111110001011000111101111111111000000110110000001110011011100010111000110100111001111100101010011010010101110111101011111110011010001110100110101100100000111001000100111011011110100100000010010001001100000100101000011111000011111100001101111001100101100001010100110001101000100100110011110011111001000100000000010110100101011111110011000110001011011000110110000110011101100101110010110001100110111000111110000100011000011110101101001";
		//		String ind11 = "1011011110111011111100101010010111010011001101101001011111111100010110000011111100111010000110011110011001010101111101000000110000110000100000111101000010101111001100101101111100101110001111111000111100011010000001001000100100000111101101100011101000111101100000010011100011001000100111110110010011100111101011010000101000010100000111011110000110110011011010111001000011011000011100001001110011100010011010101111010101110001000101111011100000000001100101010001011010010001000011001010001011001100110010101111101010100101101111110100101011010010011111111001000101011001110001110001000001010011010101001111000100001010010001001000110010100101110000110101111001101100000110110010001100110101001001100000101111100001110101001011000001000011010101101110001101111000110001011101011110110000110000100111010000010000010001001010101011001101100101001100001110110011111101101110101100000000100001100111000001101110101010111101011000101011001000111001100001000010111000010011100111100011001100101101101101000101110111110100111010001010";
		//		ExportKey.exportBinaryIndividualForEvaluation(ind1);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind2);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind3);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind4);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind5);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind6);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind7);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind8);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind9);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind10);
		//		ExportKey.exportBinaryIndividualForEvaluation(ind11);


		// Switching OFF auto evaluation flag
		autoEvaluatingKeys = false;

		System.out.println("[LOG - DEBUG] -- runEvaluationTests() duration: " + ((System.currentTimeMillis() - evaluationTestsStartTime)/1000.00) + " s");
	}
}